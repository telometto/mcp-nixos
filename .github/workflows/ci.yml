name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'website/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.cursorrules'
      - 'RELEASE_NOTES.md'
      - 'RELEASE_WORKFLOW.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'website/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.cursorrules'
      - 'RELEASE_NOTES.md'
      - 'RELEASE_WORKFLOW.md'

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Check flake
      run: nix flake check

  build:
    runs-on: ubuntu-latest
    needs: check
    steps:
    - uses: actions/checkout@v6

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Build Nix package
      run: nix build

    - name: Test package runs
      run: |
        timeout 5s ./result/bin/mcp-nixos --help || true

    - name: Build Python distribution
      run: |
        nix develop --command python -m build
        ls -la dist/

    - name: Validate package metadata
      run: nix develop --command twine check dist/*

  lint:
    runs-on: ubuntu-latest
    needs: check
    steps:
    - uses: actions/checkout@v6

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Lint with ruff
      run: |
        nix develop --command ruff check mcp_nixos/ tests/
        nix develop --command ruff format --check mcp_nixos/ tests/

    - name: Type check with mypy
      run: nix develop --command mypy mcp_nixos/

  test:
    runs-on: ubuntu-latest
    needs: check
    steps:
    - uses: actions/checkout@v6

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Run tests
      timeout-minutes: 10
      run: |
        nix develop --command pytest tests/ -v -n auto --cov=mcp_nixos --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        slug: utensils/mcp-nixos
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Docker build - after all tests pass
  docker-build:
    runs-on: ${{ matrix.runner }}
    needs: [build, lint, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
            system: x86_64-linux
          - runner: ubuntu-24.04-arm
            arch: arm64
            system: aarch64-linux
    permissions:
      packages: write

    steps:
    - uses: actions/checkout@v6

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Docker image with Nix
      run: nix build .#packages.${{ matrix.system }}.docker

    - name: Load and push arch-specific image
      run: |
        VERSION=$(nix eval --raw .#packages.${{ matrix.system }}.mcp-nixos.version)
        docker load < result
        # Push arch-specific tags
        docker tag ghcr.io/utensils/mcp-nixos:$VERSION ghcr.io/utensils/mcp-nixos:latest-${{ matrix.arch }}
        docker tag ghcr.io/utensils/mcp-nixos:$VERSION utensils/mcp-nixos:latest-${{ matrix.arch }}
        docker push ghcr.io/utensils/mcp-nixos:latest-${{ matrix.arch }}
        docker push utensils/mcp-nixos:latest-${{ matrix.arch }}

  docker-manifest:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      packages: write

    steps:
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and push multi-arch manifest
      run: |
        for registry in "utensils/mcp-nixos" "ghcr.io/utensils/mcp-nixos"; do
          docker manifest create $registry:latest \
            $registry:latest-amd64 \
            $registry:latest-arm64
          docker manifest push $registry:latest
        done
